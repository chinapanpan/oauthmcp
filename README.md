# OAuth MCP Demo

ä¸€ä¸ªå®Œæ•´çš„ OAuth 2.0 + MCP (Model Context Protocol) æ¼”ç¤ºé¡¹ç›®ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ OAuth è®¤è¯ä¿æŠ¤ MCP æœåŠ¡å™¨ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. å¯åŠ¨æœåŠ¡å™¨
python start_servers.py

# 3. æµ‹è¯•ï¼ˆåœ¨æ–°ç»ˆç«¯ï¼‰
python test_oauth_flow.py
```

## ğŸ“¡ æœåŠ¡åœ°å€

- **OAuth æœåŠ¡å™¨**: http://127.0.0.1:5000
- **MCP æœåŠ¡å™¨**: http://127.0.0.1:5001

## ğŸ”„ OAuth æ—¶åºå›¾

### å®Œæ•´æˆæƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client â”‚          â”‚   MCP   â”‚          â”‚  OAuth  â”‚          â”‚Resource â”‚
â”‚         â”‚          â”‚  Server â”‚          â”‚  Server â”‚          â”‚   API   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  1. Initialize     â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  2. Return OAuth   â”‚                    â”‚                    â”‚
     â”‚     Metadata       â”‚                    â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  3. Register Clientâ”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  4. Client ID/Secret                    â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  5. Authorization Request               â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  6. Authorization Code                  â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  7. Token Request  â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  8. Access Token   â”‚                    â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  9. Call MCP Tool (with token)          â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚  10. Access API (with token)            â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚  11. Verify Token  â”‚                    â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚  12. Return Data   â”‚                    â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚  13. Return Result â”‚                    â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

### å…³é”®æ­¥éª¤è¯´æ˜

1. **åˆå§‹åŒ–**: å®¢æˆ·ç«¯è¿æ¥ MCP æœåŠ¡å™¨ï¼Œè·å– OAuth é…ç½®ä¿¡æ¯
2. **è¿”å›å…ƒæ•°æ®**: MCP æœåŠ¡å™¨è¿”å› OAuth ç«¯ç‚¹åœ°å€å’Œæ”¯æŒçš„ scopes
3. **å®¢æˆ·ç«¯æ³¨å†Œ**: å®¢æˆ·ç«¯å‘ OAuth æœåŠ¡å™¨åŠ¨æ€æ³¨å†Œï¼Œè·å–å‡­è¯
4. **æˆæƒè¯·æ±‚**: å®¢æˆ·ç«¯è¯·æ±‚ç”¨æˆ·æˆæƒï¼ˆdemo æ¨¡å¼è‡ªåŠ¨æ‰¹å‡†ï¼‰
5. **æˆæƒç **: OAuth æœåŠ¡å™¨è¿”å›æˆæƒç 
6. **ä»¤ç‰Œäº¤æ¢**: ä½¿ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
7. **è°ƒç”¨å·¥å…·**: å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œè°ƒç”¨ MCP å·¥å…·
8. **è®¿é—® API**: MCP æœåŠ¡å™¨ä½¿ç”¨ä»¤ç‰Œè®¿é—®å—ä¿æŠ¤çš„èµ„æº
9. **éªŒè¯ä»¤ç‰Œ**: èµ„æºæœåŠ¡å™¨éªŒè¯ JWT ä»¤ç‰Œ
10. **è¿”å›æ•°æ®**: è¿”å›å—ä¿æŠ¤çš„èµ„æºæ•°æ®

## âš™ï¸ é…ç½®è¯´æ˜

### config.py é…ç½®é¡¹

```python
# OAuth æœåŠ¡å™¨é…ç½®
OAUTH_SERVER_HOST = "127.0.0.1"      # OAuth æœåŠ¡å™¨åœ°å€
OAUTH_SERVER_PORT = 5000              # OAuth æœåŠ¡å™¨ç«¯å£
OAUTH_ISSUER = "http://127.0.0.1:5000"  # OAuth é¢å‘è€… URL

# MCP æœåŠ¡å™¨é…ç½®
MCP_SERVER_HOST = "127.0.0.1"        # MCP æœåŠ¡å™¨åœ°å€
MCP_SERVER_PORT = 5001                # MCP æœåŠ¡å™¨ç«¯å£
MCP_SERVER_URL = "http://127.0.0.1:5001"  # MCP æœåŠ¡å™¨å®Œæ•´ URL

# å®‰å…¨é…ç½®
SECRET_KEY = "dev-secret-key-change-in-production"  # JWT ç­¾åå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰

# Demo æ¨¡å¼é…ç½®
DEMO_MODE = True                      # æ˜¯å¦å¯ç”¨æ¼”ç¤ºæ¨¡å¼
DEMO_AUTHORIZATION_CODE = "DEMO_AUTH_CODE_12345"  # æ¼”ç¤ºç”¨å›ºå®šæˆæƒç 
DEMO_CLIENT_ID = "demo_client"        # æ¼”ç¤ºç”¨å›ºå®šå®¢æˆ·ç«¯ ID
DEMO_CLIENT_SECRET = "demo_secret"    # æ¼”ç¤ºç”¨å›ºå®šå®¢æˆ·ç«¯å¯†é’¥

# OAuth ç«¯ç‚¹ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
AUTHORIZATION_ENDPOINT = "http://127.0.0.1:5000/oauth/authorize"
TOKEN_ENDPOINT = "http://127.0.0.1:5000/oauth/token"
REGISTRATION_ENDPOINT = "http://127.0.0.1:5000/oauth/register"
JWKS_URI = "http://127.0.0.1:5000/.well-known/jwks.json"
```

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
OAUTH_SERVER_HOST=127.0.0.1
OAUTH_SERVER_PORT=5000
MCP_SERVER_HOST=127.0.0.1
MCP_SERVER_PORT=5001

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-here

# Demo æ¨¡å¼
DEMO_MODE=true
```

## ğŸ”§ MCP å®¢æˆ·ç«¯é…ç½®

### Cursor é…ç½®

åœ¨ Cursor çš„ MCP è®¾ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆé€šå¸¸åœ¨ `~/.cursor/mcp.json`ï¼‰ï¼š

```json
{
  "mcpServers": {
    "oauth-demo": {
      "url": "http://127.0.0.1:5001/mcp/v1",
      "transport": "sse"
    }
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
1. é‡å¯ Cursor
2. åœ¨å¯¹è¯ä¸­ç›´æ¥ä½¿ç”¨è‡ªç„¶è¯­è¨€ï¼š
   ```
   è¯·å¸®æˆ‘è®¤è¯åˆ° OAuth æœåŠ¡å™¨
   è·å–æ•°æ®åˆ—è¡¨
   åˆ›å»ºä¸€ä¸ªåä¸º "Test" å€¼ä¸º 100 çš„é¡¹ç›®
   ```

### Amazon Q CLI é…ç½®

```json
{
  "mcp": {
    "servers": {
      "oauth-demo": {
        "url": "http://127.0.0.1:5001/mcp/v1",
        "transport": "http"
      }
    }
  }
}
```

### MCP Inspector é…ç½®

1. **MCP æœåŠ¡å™¨ URL**: `http://127.0.0.1:5001/mcp/v1`
2. **ä¼ è¾“æ–¹å¼**: SSE æˆ– HTTP
3. OAuth è®¤è¯ä¼šè‡ªåŠ¨è¿›è¡Œ

## ğŸ› ï¸ MCP å·¥å…·åˆ—è¡¨

| å·¥å…·åç§° | æè¿° | æ‰€éœ€æƒé™ | å‚æ•° |
|---------|------|---------|------|
| `oauth_authenticate` | OAuth è®¤è¯ | æ—  | æ—  |
| `get_user_profile` | è·å–ç”¨æˆ·èµ„æ–™ | read | æ—  |
| `get_data` | è·å–æ•°æ®åˆ—è¡¨ | read | æ—  |
| `create_data` | åˆ›å»ºæ•°æ® | write | name, value |
| `update_data` | æ›´æ–°æ•°æ® | write | item_id, name, value |
| `delete_data` | åˆ é™¤æ•°æ® | write | item_id |

## ğŸ“‹ API ç«¯ç‚¹

### OAuth æœåŠ¡å™¨ (Port 5000)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/oauth/register` | POST | åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ |
| `/oauth/authorize` | GET | æˆæƒç«¯ç‚¹ |
| `/oauth/token` | POST | ä»¤ç‰Œç«¯ç‚¹ |
| `/.well-known/oauth-authorization-server` | GET | OAuth å…ƒæ•°æ® |
| `/.well-known/jwks.json` | GET | å…¬é’¥é›† |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

### MCP æœåŠ¡å™¨ (Port 5001)

**MCP åè®®ç«¯ç‚¹ï¼š**
| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/mcp/v1/initialize` | POST | MCP åˆå§‹åŒ– |
| `/mcp/v1/tools/list` | POST | åˆ—å‡ºå·¥å…· |
| `/mcp/v1/tools/call` | POST | è°ƒç”¨å·¥å…· |
| `/mcp/v1/sse` | GET | SSE æµå¼è¿æ¥ |

**èµ„æº API ç«¯ç‚¹ï¼ˆéœ€è¦ OAuthï¼‰ï¼š**
| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ | æ‰€éœ€æƒé™ |
|-----|------|------|---------|
| `/api/user/profile` | GET | è·å–ç”¨æˆ·èµ„æ–™ | read |
| `/api/data` | GET | è·å–æ•°æ®åˆ—è¡¨ | read |
| `/api/data` | POST | åˆ›å»ºæ•°æ® | write |
| `/api/data/:id` | PUT | æ›´æ–°æ•°æ® | write |
| `/api/data/:id` | DELETE | åˆ é™¤æ•°æ® | write |

## ğŸ’¡ OAuth æµç¨‹è¯´æ˜

æœ¬é¡¹ç›®å®ç°äº†**è‡ªåŠ¨ OAuth è®¤è¯æ¨¡å¼**ï¼š

- âœ… **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šåœ¨ MCP åˆå§‹åŒ–æ—¶è‡ªåŠ¨è§¦å‘ OAuth æµç¨‹
- âœ… **æ— éœ€æ‰‹åŠ¨è®¤è¯**ï¼šç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨å·¥å…·ï¼Œæ— éœ€å…ˆè°ƒç”¨ `oauth_authenticate`
- âœ… **æœåŠ¡å™¨ç®¡ç† Token**ï¼šToken ç”± MCP æœåŠ¡å™¨è‡ªåŠ¨ç®¡ç†å’Œåˆ·æ–°
- âœ… **é€‚åˆæ¼”ç¤ºå­¦ä¹ **ï¼šæ›´å®¹æ˜“ç†è§£ OAuth + MCP çš„é›†æˆ

**å·¥ä½œæµç¨‹**ï¼š
1. Cursor è¿æ¥ MCP æœåŠ¡å™¨ï¼ˆinitializeï¼‰
2. æœåŠ¡å™¨è‡ªåŠ¨å‘ OAuth æœåŠ¡å™¨æ³¨å†Œå®¢æˆ·ç«¯å¹¶è·å– token
3. æ‰€æœ‰å·¥å…·è°ƒç”¨è‡ªåŠ¨ä½¿ç”¨å­˜å‚¨çš„ token
4. ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥ï¼Œç›´æ¥ä½¿ç”¨å³å¯

## ğŸ¯ åœ¨ Cursor ä¸­ä½¿ç”¨

### é…ç½® MCP æœåŠ¡å™¨

åœ¨ Cursor çš„ MCP é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

**macOS/Linux**: `~/.cursor/mcp.json`  
**Windows**: `%APPDATA%\Cursor\mcp.json`

```json
{
  "mcpServers": {
    "oauth-mcp-demo": {
      "command": "npx",
      "args": [
        "mcp-remote",
        "http://127.0.0.1:5001/mcp/v1"
      ]
    }
  }
}
```

### ä½¿ç”¨æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡å™¨**ï¼š
   ```bash
   # æ–¹å¼ 1ï¼šä½¿ç”¨ Python è„šæœ¬ï¼ˆæ¨èï¼‰
   python start_servers.py
   
   # æ–¹å¼ 2ï¼šæ‰‹åŠ¨å¯åŠ¨ï¼ˆå¦‚æœè„šæœ¬æœ‰é—®é¢˜ï¼‰
   source venv/bin/activate
   export AUTHLIB_INSECURE_TRANSPORT=1
   python oauth_server.py > log/oauth.log 2>&1 &
   python mcp_server.py > log/mcp.log 2>&1 &
   ```

2. **é‡å¯ Cursor**ï¼šé…ç½®æ–‡ä»¶ä¿®æ”¹åéœ€è¦é‡å¯ Cursor

3. **éªŒè¯è¿æ¥**ï¼šåœ¨ Cursor çš„æ—¥å¿—ä¸­åº”è¯¥çœ‹åˆ°ï¼š
   ```
   Connected to remote server using StreamableHTTPClientTransport
   Proxy established successfully
   Found 6 tools, 0 prompts, and 0 resources
   ```

4. **ä½¿ç”¨å·¥å…·**ï¼š
   - **æ— éœ€æ‰‹åŠ¨è®¤è¯ï¼** ç›´æ¥å¯¹ AI è¯´ï¼š"å¸®æˆ‘è·å–æ‰€æœ‰æ•°æ®"
   - OAuth è®¤è¯ä¼šåœ¨åå°è‡ªåŠ¨å®Œæˆ
   - æ”¯æŒçš„æ“ä½œï¼šè·å–æ•°æ®ã€åˆ›å»ºæ•°æ®ã€æ›´æ–°æ•°æ®ã€åˆ é™¤æ•°æ®ç­‰

### å¯ç”¨å·¥å…·

| å·¥å…·åç§° | è¯´æ˜ | å‚æ•° |
|---------|------|------|
| `oauth_authenticate` | è·å– OAuth è®¿é—®ä»¤ç‰Œ | æ—  |
| `get_user_profile` | è·å–ç”¨æˆ·èµ„æ–™ | æ—  |
| `get_data` | è·å–æ•°æ®åˆ—è¡¨ | æ—  |
| `create_data` | åˆ›å»ºæ–°æ•°æ® | `name`, `value` |
| `update_data` | æ›´æ–°æ•°æ® | `item_id`, `name`, `value` |
| `delete_data` | åˆ é™¤æ•°æ® | `item_id` |

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### 1. æµ‹è¯• OAuth æµç¨‹

```bash
python test_oauth_flow.py
```

### 2. æ‰‹åŠ¨æµ‹è¯• API

```bash
# æ³¨å†Œå®¢æˆ·ç«¯
curl -X POST http://127.0.0.1:5000/oauth/register \
  -H "Content-Type: application/json" \
  -d '{
    "client_name": "Test Client",
    "redirect_uris": ["http://localhost:8080/callback"],
    "grant_types": ["client_credentials"],
    "scope": "read write"
  }'

# è·å–ä»¤ç‰Œ
curl -X POST http://127.0.0.1:5000/oauth/token \
  -d "grant_type=client_credentials" \
  -d "client_id=YOUR_CLIENT_ID" \
  -d "client_secret=YOUR_CLIENT_SECRET" \
  -d "scope=read write"

# è®¿é—®å—ä¿æŠ¤èµ„æº
curl -X GET http://127.0.0.1:5001/api/data \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 3. æµ‹è¯• MCP åè®®

```bash
# åˆå§‹åŒ–
curl -X POST http://127.0.0.1:5001/mcp/v1/initialize \
  -H "Content-Type: application/json" \
  -d '{"protocolVersion": "2024-11-05", "capabilities": {}, "clientInfo": {"name": "test", "version": "1.0"}}'

# åˆ—å‡ºå·¥å…·
curl -X POST http://127.0.0.1:5001/mcp/v1/tools/list

# è°ƒç”¨å·¥å…·
curl -X POST http://127.0.0.1:5001/mcp/v1/tools/call \
  -H "Content-Type: application/json" \
  -d '{"name": "oauth_authenticate", "arguments": {}}'
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     MCP Client          â”‚  (Cursor, Amazon Q CLI, MCP Inspector)
â”‚    (AI Assistant)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Streamable HTTP (SSE)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     MCP Server          â”‚  Port: 5001
â”‚   (mcp_server.py)       â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MCP Protocol    â”‚   â”‚  /mcp/v1/*
â”‚  â”‚  - Initialize    â”‚   â”‚  - å·¥å…·åˆ—è¡¨
â”‚  â”‚  - List Tools    â”‚   â”‚  - å·¥å…·è°ƒç”¨
â”‚  â”‚  - Call Tool     â”‚   â”‚  - SSE æµ
â”‚  â”‚  - SSE Stream    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Resource API    â”‚   â”‚  /api/*
â”‚  â”‚  (OAuth Protected)â”‚  â”‚  - ç”¨æˆ·èµ„æ–™
â”‚  â”‚  - JWT Verify    â”‚   â”‚  - CRUD æ“ä½œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ OAuth 2.0
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    OAuth Server         â”‚  Port: 5000
â”‚  (oauth_server.py)      â”‚
â”‚                         â”‚
â”‚  - åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ        â”‚
â”‚  - æˆæƒç æµç¨‹           â”‚
â”‚  - ä»¤ç‰Œé¢å‘/åˆ·æ–°        â”‚
â”‚  - JWT ç­¾å             â”‚
â”‚  - JWKS å…¬é’¥            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- âœ… **OAuth 2.0 æˆæƒæœåŠ¡å™¨**ï¼šæ”¯æŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ (RFC 7591)
- âœ… **MCP æœåŠ¡å™¨ï¼ˆStreamable HTTPï¼‰**ï¼šå®ç° SSE æµå¼ä¼ è¾“åè®®
- âœ… **å—ä¿æŠ¤çš„èµ„æº API**ï¼šé›†æˆåœ¨ MCP æœåŠ¡å™¨ä¸­ï¼Œä½¿ç”¨ JWT éªŒè¯
- âœ… **å¤šç§æˆæƒæ¨¡å¼**ï¼šæ”¯æŒ Client Credentialsã€Authorization Codeã€Refresh Token
- âœ… **è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°**ï¼šè®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
- âœ… **MCP è§„èŒƒåˆè§„**ï¼šå®ç° Protected Resource Metadata (RFC 9728) å’Œ Authorization Server Metadata (RFC 8414)
- âœ… **æ ‡å‡†å‘ç°æœºåˆ¶**ï¼šæ”¯æŒ `.well-known` ç«¯ç‚¹å’Œ WWW-Authenticate header
- âœ… **CORS æ”¯æŒ**ï¼šæ‰€æœ‰ API ç«¯ç‚¹æ”¯æŒè·¨åŸŸè¯·æ±‚

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

âš ï¸ **è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºé¡¹ç›®ï¼Œä¸é€‚åˆç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼**

**é‡è¦æç¤º**ï¼šæœ¬é¡¹ç›®ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä½¿ç”¨ HTTP è€Œé HTTPSã€‚åœ¨ä»£ç ä¸­è®¾ç½®äº† `AUTHLIB_INSECURE_TRANSPORT=1` ç¯å¢ƒå˜é‡æ¥ç¦ç”¨ HTTPS æ£€æŸ¥ã€‚**è¿™ä»…ç”¨äºå¼€å‘å’Œæ¼”ç¤ºï¼Œç»ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼**

### ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘ï¼š

1. **HTTPS**ï¼š**å¿…é¡»**ä½¿ç”¨ TLS åŠ å¯†æ‰€æœ‰é€šä¿¡ï¼Œç§»é™¤ `AUTHLIB_INSECURE_TRANSPORT` è®¾ç½®
2. **SECRET_KEY**ï¼šä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼Œä¸è¦ä½¿ç”¨é»˜è®¤å€¼
3. **æŒä¹…åŒ–å­˜å‚¨**ï¼šä½¿ç”¨æ•°æ®åº“ï¼ˆPostgreSQL/MySQLï¼‰è€Œä¸æ˜¯å†…å­˜å­˜å‚¨
4. **å¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ AWS KMSã€HashiCorp Vaultï¼‰
5. **ç”¨æˆ·è®¤è¯**ï¼šå®ç°çœŸå®çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
6. **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢ API æ»¥ç”¨
7. **æ—¥å¿—å’Œç›‘æ§**ï¼šè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³äº‹ä»¶
8. **ä»¤ç‰Œæ’¤é”€**ï¼šå®ç°ä»¤ç‰Œæ’¤é”€æœºåˆ¶
9. **PKCE**ï¼šå¯¹äºå…¬å…±å®¢æˆ·ç«¯ä½¿ç”¨ PKCE æ‰©å±•
10. **CORS é™åˆ¶**ï¼šé™åˆ¶å…è®¸çš„æ¥æºåŸŸåï¼Œä¸è¦ä½¿ç”¨ `*`

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šCursor æ— æ³•è¿æ¥åˆ° MCP æœåŠ¡å™¨

**ç—‡çŠ¶**ï¼šCursor æ˜¾ç¤º "Cannot read properties of undefined (reading 'value')" é”™è¯¯

**åŸå› **ï¼šMCP æœåŠ¡å™¨éœ€è¦è¿”å› JSON-RPC 2.0 æ ¼å¼çš„å“åº”ï¼Œè€Œä¸æ˜¯æ™®é€šçš„ JSON å¯¹è±¡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ `mcp_server.py`ï¼ˆå·²å®ç° JSON-RPC æ”¯æŒï¼‰
- é‡å¯ MCP æœåŠ¡å™¨
- æµ‹è¯• JSON-RPC æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼š
  ```bash
  curl -X POST http://127.0.0.1:5001/mcp/v1 \
    -H "Content-Type: application/json" \
    -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0.0"}}}'
  ```
  
  åº”è¯¥è¿”å›åŒ…å« `"jsonrpc": "2.0"` å’Œ `"result"` å­—æ®µçš„å“åº”ã€‚

### é—®é¢˜ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :5000
lsof -i :5001

# æŸ¥çœ‹å¥åº·çŠ¶æ€
curl http://127.0.0.1:5000/health
curl http://127.0.0.1:5001/health
```

### é—®é¢˜ï¼šToken éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ OAuth æœåŠ¡å™¨å’Œ MCP æœåŠ¡å™¨éƒ½åœ¨è¿è¡Œ
- æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®ï¼ˆJWT ä¾èµ–æ—¶é—´æˆ³ï¼‰
- ç¡®è®¤ token æœªè¿‡æœŸï¼ˆé»˜è®¤ 3600 ç§’ï¼‰
- å…ˆè°ƒç”¨ `oauth_authenticate` å·¥å…·è·å–æ–°ä»¤ç‰Œ

### é—®é¢˜ï¼šMCP å®¢æˆ·ç«¯æ— æ³•è¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ MCP é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ Python ç¯å¢ƒå’Œä¾èµ–å·²æ­£ç¡®å®‰è£…
- æŸ¥çœ‹ MCP å®¢æˆ·ç«¯çš„æ—¥å¿—
- ç¡®è®¤æœåŠ¡å™¨ URL å’Œç«¯å£æ­£ç¡®

## ğŸ“¦ æŠ€æœ¯æ ˆ

- **Python 3.8+**
- **Flask** - Web æ¡†æ¶
- **Flask-CORS** - CORS æ”¯æŒ
- **Authlib** - OAuth 2.0 å®ç°
- **MCP SDK** - Model Context Protocol
- **httpx** - å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
- **cryptography** - åŠ å¯†åº“ï¼ˆJWT ç­¾åï¼‰
- **python-dotenv** - ç¯å¢ƒå˜é‡ç®¡ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
oauth_mcp/
â”œâ”€â”€ config.py              # é…ç½®æ–‡ä»¶
â”œâ”€â”€ oauth_server.py        # OAuth æˆæƒæœåŠ¡å™¨
â”œâ”€â”€ mcp_server.py          # MCP æœåŠ¡å™¨ï¼ˆåŒ…å«èµ„æº APIï¼‰
â”œâ”€â”€ start_servers.py       # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_oauth_flow.py     # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore            # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ README.md             # æœ¬æ–‡æ¡£
```

## ğŸ“š å‚è€ƒèµ„æº

- [MCP è§„èŒƒ](https://modelcontextprotocol.io/specification/draft/basic/authorization)
- [OAuth 2.0 RFC 6749](https://tools.ietf.org/html/rfc6749)
- [OAuth 2.0 åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ RFC 7591](https://tools.ietf.org/html/rfc7591)
- [Protected Resource Metadata RFC 9728](https://tools.ietf.org/html/rfc9728)
- [Authorization Server Metadata RFC 8414](https://tools.ietf.org/html/rfc8414)

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åˆ›å»º Issueã€‚
